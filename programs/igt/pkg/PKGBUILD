pkgname=igt
pkgver=git
pkgrel=1
arch=('i386' 'x86_64' 'aarch64')
url="https://gitlab.freedesktop.org/drm/igt-gpu-tools"
license=('GPL')
source=("$pkgname"::"https://gitlab.freedesktop.org/drm/igt-gpu-tools.git" 'exclude')
sha256sums=('SKIP' 'SKIP')

. $LKP_SRC/lib/install.sh
. $LKP_SRC/lib/tests/pkgbuild.sh

prepare()
{
	prepare_benchmark_path
}

build()
{
	python3 -m venv $srcdir
	. $srcdir/bin/activate

	python3 -m pip install meson
	python3 -m pip install ninja

	cd_src_pkg_dir

	meson build && ninja -C build

	deactivate
}

split_tests()
{
	cd_src_pkg_dir

	local standalone="$(get_pkg_dir $pkgname)/addon/tests/standalone"
	# standalone test
	for test in $(cat $standalone | grep -v '^#')
	do
		echo $test > ./$test
	done

	standalone_tests=`paste -sd '|' <(cat $standalone | grep -v '^#')`
	sed -n '2p' build/tests/test-list.txt | tr " " "\n" | grep -v amdgpu | grep -vE "$standalone_tests" | sort > all-tests

	$LKP_SRC/tools/split-tests all-tests 25 group-
}

package()
{
	split_tests

	pack_src_pkg_contents

	pack_contents ${srcdir}/exclude $benchmark_path
}
