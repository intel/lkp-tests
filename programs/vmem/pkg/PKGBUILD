pkgname=vmem
pkgver=git
pkgrel=1
url='https://github.com/pmem/vmem'
arch=('i386' 'x86_64' 'aarch64')
license=('Intel' 'Apache 2.0' 'BSD' 'GPL 2.1' )
source=('https://github.com/pmem/vmem.git'
	'https://github.com/pmem/valgrind.git#branch=pmem-3.20'
	'https://github.com/llvm-mirror/llvm.git'
	'https://github.com/llvm-mirror/libcxxabi.git'
	'https://github.com/pmem/libcxx.git'
	'https://github.com/pmem/pmdk.git#branch=stable-2.1'
	'https://github.com/pmem/ndctl.git#branch=pending')
md5sums=('SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP')

. $LKP_SRC/lib/env.sh
. $LKP_SRC/lib/tests/pkgbuild.sh


build_ndctl()
{
	cd_src_pkg_dir ndctl

	[[ -e '/usr/include/iniparser.h' ]] || cp /usr/include/iniparser/* /usr/include/
	meson setup build
	meson configure -Dtest=enabled -Ddocs=disabled build
	meson compile -C build
}

# Test vmem_malloc, will use daxio command, it located in pmdk/src/tools.
build_pmdk()
{
	cd_src_pkg_dir pmdk
	make
}


build()
{
	[ "$DISTRO" = "centos" ] && {
		cd_src_pkg_dir nvml

		sed -i 's/CXXFLAGS += -Wno-unknown-attributes/CXXFLAGS += -Wno-ignored-attributes/' ./src/benchmarks/Makefile
	}

	build_install_valgrind_pmem
	build_ndctl
	build_pmdk
	build_install_libcxx
}

package()
{
	pack_src_pkg_contents

	cd_src_pkg_dir valgrind
	make install DESTDIR="${pkgdir}"
	cp -af "/usr/local/libcxx" "${pkgdir}/usr/local"

	cd_src_pkg_dir ndctl
	make install DESTDIR="${pkgdir}"

	cd_src_pkg_dir pmdk
	make install DESTDIR="${pkgdir}"
}
