pkgname=nvml
pkgver=git
pkgrel=1
url='https://github.com/pmem/nvml.git'
arch=('i386' 'x86_64' 'aarch64')
license=('Intel' 'GPL' 'BSD')
source=('https://github.com/pmem/valgrind.git'
	'https://github.com/llvm-mirror/llvm.git'
	'https://github.com/llvm-mirror/libcxxabi.git'
	'https://github.com/pmem/libcxx.git'
	'https://github.com/ofiwg/libfabric.git'
	'https://github.com/pmem/nvml.git')
md5sums=('SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP')

. $LKP_SRC/lib/env.sh
. $LKP_SRC/lib/tests/pkgbuild.sh


build_install_libfabric()
{
	cd_src_pkg_dir libfabric
	./autogen.sh
	./configure --prefix=/usr/local --with-valgrind=/usr/local
	make
	make install
}

build()
{
	[ "$DISTRO" = "centos" ] && {
		cd_src_pkg_dir nvml
		sed -i 's/CXXFLAGS += -Wno-unknown-attributes/CXXFLAGS += -Wno-ignored-attributes/' ./src/benchmarks/Makefile
	}

	build_install_valgrind_pmem
	build_install_libfabric
	build_install_libcxx
}

package()
{
	pack_src_pkg_contents

	cd_src_pkg_dir valgrind
	make install DESTDIR="${pkgdir}"

	cd_src_pkg_dir libfabric
	make install DESTDIR="${pkgdir}"

	pack_contents /usr/local/libcxx
}
