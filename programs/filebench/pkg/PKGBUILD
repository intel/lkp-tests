pkgname=filebench
pkgver=git
pkgrel=1
url="https://github.com/filebench/filebench"
arch=('x86_64' 'i386' 'aarch64')
license=('GPL')
source=("https://github.com/filebench/filebench.git")
md5sums=('SKIP')

. $LKP_SRC/lib/tests/pkgbuild.sh

prepare()
{
	prepare_benchmark_path
}

build()
{
	cd_src_pkg_dir

	for file in $(ls workloads/*.f); do
		# Add run command if workload doesn't include run command.  Fix
		# "Warning: no run command in the WML script!" error during test.
		grep -q ^run $file || echo -e "\nrun 60" >>$file
		# Remove obsolete cached attribute because filebench commit 7080d60
		# has deleted it.  Fix "syntax error at 'cached'" during test.
		sed -i '/set \$cached=false/d' $file
		sed -ri 's/(.*),cached=\$cached/\1/g' $file
	done

	libtoolize
	aclocal
	autoheader
	automake --add-missing
	autoconf
	./configure --prefix $benchmark_path
	make
}

package()
{
	make_install_src_pkg
}
