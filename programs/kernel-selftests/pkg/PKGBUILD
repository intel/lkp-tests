pkgname=kernel-selftests
pkgver=git
pkgrel=1
arch=('i686' 'x86_64' 'aarch64')
url="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git"
license=('GPL')
source=('https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' 'https://git.kernel.org/pub/scm/devel/pahole/pahole.git' 'https://git.kernel.org/pub/scm/network/iproute2/iproute2-next.git')
md5sums=('SKIP' 'SKIP' 'SKIP')

# Download kernel from git.kernel.org.
# If the kernel has been download into the computer, you can copy it to ${srcdir}.
# As far as possible, please keep the version of source code same with the installed kernel.
# If you want test a specfied version, you can download the code first, build and install it,
# then restart the machine using the new kernel. Lastly, you can start to test it.

. $LKP_SRC/lib/debug.sh
. $LKP_SRC/lib/tests/pkgbuild.sh

prepare()
{
	prepare_benchmark_path
}

get_kernel_version()
{
	# format: X.Y.Z-...
	local version=$(uname -r)
	# format: X.Y.Z
	local a=${version%%-*}
	# format: X.Y
	local b=${a%.*}
	echo "v$b"
}

build_tools()
{
	cd_src_pkg_dir linux
	if [[ -d .git ]]; then
		local installed_version="$(get_kernel_version)"
		git tag | grep -x "${installed_version}" || die "can not bring the download kernel version into correspondence with the installed kernel"
		echo "switch to version $installed_version ..."
		git checkout -b "test-${installed_version}" "$installed_version"
	else
		echo "please make sure the version of current kernel is $installed_version"
	fi

	make allyesconfig
	make prepare
	# build cpupower
	cd tools/power/cpupower
	make
}

install_selftests()
{
	cd_src_pkg_dir linux

	local header_dir="/tmp/linux-headers"

	mkdir -p "${header_dir}"
	make headers_install INSTALL_HDR_PATH="${header_dir}"

	pack_contents "${header_dir}/include" "${benchmark_path}/usr"
	pack_contents "${header_dir}/include/asm" "${benchmark_path}/tools/include/uapi"

	local dir
	for dir in arch/x86 scripts kernel/bpf samples Makefile tools include lib
	do
		pack_contents $dir $(dirname ${benchmark_path}/$dir)
	done
}

build()
{
	build_iproute2
	build_tools
	build_pahole
}

package()
{
	install_selftests

	# for hid group
	pip3_install pytest-tap

	# When using pip to install packages system-wide, they are usually installed
	# in /usr/local/lib/python3.x/dist-packages or site-packages
	pack_contents /usr/local/lib

	# install cpupower command and library
	cd_src_pkg_dir linux/tools/power/cpupower
	make install DESTDIR="$pkgdir"
}
