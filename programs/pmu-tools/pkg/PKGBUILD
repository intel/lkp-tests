pkgname=pmu-tools
pkgver=git
pkgrel=1
pkgdesc="A collection of tools for profile collection and performance analysis on Intel CPUs on top of Linux perf. This uses performance counters in the CPU."
arch=('i386' 'x86_64' 'aarch64')
url="https://github.com/andikleen/pmu-tools.git"
license=('GPL2' 'BSD')
source=("https://github.com/andikleen/pmu-tools.git" "https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git")
md5sums=('SKIP' 'SKIP')

. $LKP_SRC/lib/tests/pkgbuild.sh

prepare()
{
	prepare_benchmark_path
}

build_perf()
{
    cd_src_pkg_dir linux/tools/perf

    PATH=$BUILD_DIR:$PATH make
}

bulid_pmu_tools()
{
    cd_src_pkg_dir

    files=$(grep -rl "^#\!\/usr\/bin.*python" ./)
    for file in $files
    do
        sed -i 's/\/usr\/bin\/env\ python$/\/usr\/bin\/env\ python3/g' "$file"
        sed -i 's/\/usr\/bin\/python$/\/usr\/bin\/python3/g' "$file"
    done

    cd_src_pkg_dir pmu-tools/jevents
    make
}

build()
{
    build_perf
    bulid_pmu_tools
}

package()
{
    cd_src_pkg_dir

    XDG_CACHE_HOME="$benchmark_path" ./event_download.py -a

    pack_src_pkg_contents
    pack_contents "$srcdir/linux/tools/perf/perf" "$benchmark_path"
}
